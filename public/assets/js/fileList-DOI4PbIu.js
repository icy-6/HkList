import{q as I,a as B,b as r,cb as E,cc as K,M as i,cd as C,ce as V}from"./index-DfK_AuQa.js";import{f as j}from"./format-YoKwq1Pz.js";const F=B(),O=I("fileList",()=>{const a=r({url:"",surl:"",pwd:"",dir:"/",parse_password:""}),n=r(),f=r([]),M=()=>f.value.length===0?"/":f.value[f.value.length-2]??"/",P=async()=>{u.value=[];const l=await E(a.value);n.value=l.data,a.value.dir!=="/"?n.value.list.unshift({category:-1,fs_id:0,is_dir:!0,local_ctime:0,local_mtime:0,server_ctime:0,server_mtime:0,size:0,md5:"",path:M(),server_filename:"返回上一层",dlink:""}):f.value=[]},g=r({token:localStorage.getItem("token")??"guest"}),x=r({count:0,size:0,expires_at:"1970-01-01 08:00:00"}),h=r(""),S=async()=>{var l,v;try{await F.getConfig();const t=await K(g.value);x.value=t.data,h.value="",localStorage.setItem("token",g.value.token)}catch(t){const _=(v=(l=t==null?void 0:t.response)==null?void 0:l.data)==null?void 0:v.message;_&&(h.value=_)}},u=r([]),c=r([]),b=(l,v)=>{u.value=l,c.value=v.selectedRowData},d=r({hit_captcha:!1,vcode_str:"",vcode_img:"",vcode_input:""}),k=r(!1),L=r([]);return{GetFileListReq:a,GetFileListRes:n,getFileList:P,GetLimitReq:g,GetLimitRes:x,GetLimitError:h,getLimit:S,selectedRowKeys:u,handleSelectChange:b,getDownloadLinks:async(l,v)=>{var $,D,G;if(k.value)return i.error("正在解析中,请稍后再试"),!1;const{config:t}=F;if(l)if(typeof l=="number"){const e=await C({randsk:n.value.randsk,uk:n.value.uk,shareid:n.value.shareid,fs_id:[l],surl:a.value.surl,dir:a.value.dir,pwd:a.value.pwd,token:g.value.token,parse_password:a.value.parse_password,vcode_str:d.value.vcode_str,vcode_input:d.value.vcode_input});return i.success("重新解析成功"),e.data}else l.stopPropagation();v&&(c.value=[v]);const _=[],w=c.value.filter(e=>(e.is_dir&&_.push(e.fs_id),e&&!e.is_dir));w.length!==c.value.length&&i.warning("暂时不支持解析文件夹"),c.value=w,u.value=u.value.filter(e=>!_.includes(e));const y=w.filter(e=>e.size>t.min_single_filesize);y.length!==w.length&&i.warning("文件过小不会被解析");const R=y.filter(e=>e.size<t.max_single_filesize);R.length!==y.length&&i.warning("文件过大不会被解析");const p=R;if(p.reduce((e,s)=>e+s.size,0)>t.max_all_filesize){i.error(`单次最多解析${j(t.max_all_filesize)}的文件`);return}if(p.length>t.max_once){i.error(`单次最多解析${t.max_once}个文件`);return}if(p.length===0){i.error("满足要求的文件数量为0");return}try{k.value=!0,d.value.hit_captcha=!1;const e=[];let s=null,o;try{for(const m in p){o=p[m],s&&s.close(),s=await i.loading(`正在解析第${parseFloat(m)+1}个文件:${o.server_filename}`,9999999);const q=await C({randsk:n.value.randsk,uk:n.value.uk,shareid:n.value.shareid,fs_id:[o.fs_id],surl:a.value.surl,dir:a.value.dir,pwd:a.value.pwd,token:g.value.token,parse_password:a.value.parse_password,vcode_str:d.value.vcode_str,vcode_input:d.value.vcode_input});e.push(...q.data),o!==null&&(u.value=u.value.filter(z=>z!==o.fs_id),c.value=c.value.filter(z=>z.fs_id!==o.fs_id))}}catch(m){throw s&&s.close(),L.value=e,i.success("部分解析成功,下滑查看解析结果"),m}s&&s.close(),i.success("解析成功,下滑查看解析结果"),L.value=e}catch(e){const s=e;if((G=(D=($=s==null?void 0:s.response)==null?void 0:$.data)==null?void 0:D.message)!=null&&G.includes("-20")){const o=await V({parse_password:a.value.parse_password});d.value={hit_captcha:!0,...o.data,vcode_input:""}}else i.error("解析可能失败或超时了,请稍后前往历史记录中尝试查询是否成功")}finally{k.value=!1,await S(),await F.getConfig()}},GetDownLoadLinksRes:L,vcode:d,paths:f}});export{O as useFileListStore};
